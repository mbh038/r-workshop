---
title: 'ANOVA: Factorial experiments and model simplification'
author: "your name"
date: "the date"
output:
  html_document:
    df_print: paged
---

```{r set-up, include = FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE)
```

This exercise sheet is heavily indebted to Michael Crawley's *Statistics: An introduction using R*, 2nd Ed, Wiley. Published in 2015 this emphasises statistics over R (in fact, much of the R he presents is written prior to the advent of the `tidyverse` dialect which we use here, and so may seem terse if that is what you are used to). It is very useful and is at a higher level than Beckerman, Childs and Petchey's *Getting Started in R: An introduction for biologists*, 2nd Ed. OUP published in 2017. Their book also includes a simpler version of the example explored here.

#### Files needed

* To be put in the Project/scripts folder:

  * `ANOVA_two_way_with_model_simplification.html` (this worksheet)
  * `ANOVA_two_way_template.Rmd` (the script where you fill in the code chunks)
  
* To be put in Project/data folder

  * `growth.csv`


### Open your Project

You should be working within a folder that you have designated as what RStudio calls a 'Project'. If you are, the name of your Project will appear at the top right of the RStudio window. Inside your Project folder you should have a `scripts` folder for scripts like this worksheet and the template file, and a `data` folder for all the data files, including the one used here, `growth.csv`.. You will also see, at the top level of the Project, the `.RProj` file. You can see all this in the Files pane, bottom-right.

### Load packages

```{r load packages, message=FALSE,warning=FALSE}
#Enter code to load the packages tidyverse, here, cowplot and ggfortify. If need be, install them first.

```

### Read in the data

The `growth.csv` data file needs to be in the `data` folder within the Project folder.

In this chunk we read the `growth.csv` data into an R object to which we give the name `weights`.

```{r}
# enter code to read the data in the growth.csv file into a data frame object called weights.

# enter code to show he structure of the weights 

```
* How many  columns and how many rows does `weights` have?
* What type of data is in each column?



### Make R recognise the categorical variables as factors, and order the levels.


In the following chunk, use `factor()` to designate both the `supplement` and `diet` columns of the data set as factors, and specify the level order of each, with `control` coming first for `supplement` and `barley` coming first for `diet`. 

```{r}
# enter code to designate the supplement and diet columns of weights as factors. Order the levels as required. Save the reuslt under the same name
weights <- weights %>%
  mutate(supplement = factor(supplement, levels=c("control","agrimore", "supergain", "supersupp")),
         diet=factor(diet, levels=c("barley","oats", "wheat")))

# enter code to check the structure of the new version of weights
glimpse(weights)
```

What are the data types now of the supplement and diet columns?

### Summarise the data

We wish to calculate the mean and standard error of the mean for each of the twelve combinations of diet and supplement. 

There isn't a function in base R with which we can calculate standard error of the mean directly, but we can do so knowing the standard deviation of the sample $\text{SD}$ (using `sd()`) and the sample size $n$ (using `n()`) using this formula:

$$ \text{SE}=\frac{SD}{\sqrt{n}}$$

```{r, eval= FALSE}
# we use the group_by() and summarise() functions from dplyr (the package within tidyverse for data manipulation) to
# calculate the mean and standard error of the mean of each combination of diet and supplement
# save the result to an object. called growth_summary


# type the name growth_summary so that it isdisplayed here

```

### Plot the data

The next step, as so often before we launch into actual statistics, is to plot the data in a way that sheds light on the question we have. Here, we can use the use the means and standard errors of the mean that we have just calculated to produce a useful kind of line plot that in this context is often referred to as an interaction plot:

```{r}
growth_summary %>%
  ggplot(aes(x=supplement,y=mean_gain,colour=diet,group=diet)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean_gain-se_gain,ymax=mean_gain+se_gain),width=0.1) +
  labs(x="Supplement",
       y="Mean weight gain") +
  scale_fill_brewer() +
  theme_cowplot()
```

#### Questions

What could the line plot look like if:

-   There were no main effect of both diet and supplement, and no interaction

-   There were a main effect of diet, no main effect of supplement and no interaction?

-   There were no main effect of diet, a main effect of supplement and no interaction?

-   There were main effects of both and an interaction between them?

The plots tell you a great deal about what main effects and/or interactions there may be.


### ANOVA

Now for the actual statistical test. We will conduct a two-way ANOVA, which will look to see if there is evidence that either diet or supplement or both affect growth rate (the so-called main effects), and if the effect of one depends on the nature of the other (the so-called interaction). THe null hypothesis is that neither has any main effect and that there is no interaction.

Now we can use either of the functions `aov()` or `lm()` to fit a factorial ANOVA (the choice affects only whether we get an ANOVA table or a list of parameter estimates as the default output from `summary()`.). Here, we will use `lm()`.

We estimate parameters for the main effects of each level of diet and each level of supplement, plus terms for the interaction between diet and supplement.

The interaction degrees of freedom are the product of those for diet and supplement ie (3-1) x (4-1) = 6.

The model is:

`gain ~ diet + supplement + diet:supplement`

which can be written more simply using the asterisk notation as:

`gain ~ diet * supplement`


#### Construct the model

```{r}
# complete this line of code to run an interactive model for the dependence of gain on diet and supplement
model0<-
```

#### Do we reject the null hypothesis?

To get an overall picture, we first use `anova()` to see if there is evidence to reject the null

```{r}
# use anova() to find out if model0 provides evidence to reject the null hypothesis (no effect of anything on gain)

```

Does the output of this show evidence for:

* A significant main effect of diet? (Y/N)
* A significant main effect of supplement? (Y/N)
* A significant interaction between diet and supplement (Y/N)

The ANOVA table does not show us effect sizes or allow us to work out which if any of the levels of the two factors are significantly different. For this, `summary()` is more useful:

```{r}
# enter code that uses the function summary() to shows effect sizes for model0

```


* Which combination of factor levels does the first row (Intercept) relate to?
* In which row does the Estimate value give the actual mean gain?
* Which rows relate to main effects? 
* Which rows relate to interactions?

Here is a table to help you interpret the output of the `summary()` function.

```{r, echo = FALSE}
library(tidytidbits)
library(kableExtra)
summary.table<-broom::tidy(summary(model0)) %>%
  mutate(absolute_value=ifelse(term=="(Intercept)",estimate, estimate+ estimate[1])) %>%
  mutate(type_of_effect=c(rep("Main effect",6),rep("Interaction",6))) %>%
  mutate (meaning = c("barley + control",
                      "oats + control",
                      "wheat + control",
                      "barley + agrimore",
                      "barley + supergain",
                      "barley + supersupp",
                      "oats + agrimore",
                      "wheat + agrimore",
                      "oats + supergain",
                      "wheat + supergain",
                      "oats + supersupp",
                      "wheat + supersupp")) %>%
  mutate(estimate=round(estimate,2),
         absolute_value = round(absolute_value,2),
         p_value=as_formatted_p_value(p.value,prefix="",alpha=0.05)) %>%
  mutate(significance = case_when(
    p.value <= 0.001 ~ "***",
    p.value > 0.001 & p.value <= 0.01 ~ "**",
    p.value > 0.01 & p.value <= 0.05 ~ '  *.  ',
    p.value > 0.05 ~ "")) %>%
  select(term, meaning,estimate, absolute_value, p_value, significance)
summary.table %>%
  kbl() %>%
  kable_styling(full_width=FALSE)
```



The output of the `summary()` function re-emphasises that none of the interaction terms are significant. It also suggests that a minimum adequate model will contain 5 parameters: an intercept, which just means that there is non-zero growth when the diet and supplement are the reference values, a difference from that growth due to changing the diet to `oats`, a difference due to changing it to`wheat`, a difference due to changing the supplement to `agrimore` while keeping barley as the diet, and a difference due to changing the supplement instead to  `suppersupp`. 

#### Model Simplification

Given the results of the full interaction model, we begin model simplification by leaving out the interaction terms, to leave us with an additive model:

```{r}
# complete the code using lm() to create. liner additive model, using diet and supplement as predciators and gain as response variable
model_1<-
  
# enter code to generate a summary table of the effects within the

```



All the rows of this table describe main effects, of making one change, to either diet or supplement.

* Is there any significant difference made to gain if supplement is changed from control to supergain, and diet is left as barley?
* Which diet seems worst?

#### Check the validity of the linear model

Here we check the validity of the linear model by graphical means.

```{r}
# enter code to produce four diagnostic plots

```

There are two main rules for validity of a linear model that we investigate in the top two plots. Which plot should we look at to see if there is

* Constant variance of residuals within groups around their respective group means
* Normal distribution of residuals within each group

Back to interpreting the output of the ANOVA:

It is clear that we need to retain all three levels of diet since the effect values of each differ from each other by an amount that is several times the standand errors, so that *t* >> 1. It is not clear that we need all the levels of supplement, however. `supersupp` is not obviously different from `agrimore` (difference = -0.727 with standard error = 0.509), yet both are clearly different from `control`. However `supergrain` is not obviously different from `control` (difference = -0.68, error = 0.509). Hence we are tempted to try a new model with just two levels of the factor supplement which we might sensibly call "best", by which we mean `agrimore` or `supersupp`, and "worst" by which we mean `control` or `supergrain`. We'll name this new factor `supp2`.

```{r}
weights <- weights %>%
  mutate(supp2=ifelse(supplement %in% c("agrimore","supersupp"),"best","worst"))
```

If we calculate the means and standard errors for weigh gain under each diet for each of the two new classifications of supplement, and then plot them, we get this new interaction plot:

```{r}
weights %>%
  group_by(diet,supp2) %>%
  summarise(mean_gain=mean(gain),se_gain=sd(gain)/sqrt(n())) %>%
  ungroup() %>%

  ggplot(aes(x=supp2,y=mean_gain,colour=diet,group=diet)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean_gain-se_gain,ymax=mean_gain+se_gain),width=0.1) +
  labs(x="Supplement",
       y="Mean weight gain") +
  scale_fill_brewer() +
  theme_cowplot()
```

From this we can see that diet clearly makes a difference, since the three lines are separated by a distance much larger than the standard errors, the better supplement clearly makes a difference since there is a consistent drop on going from 'best' to 'worst', again by an amount that is much larger than the error bars, and there is clearly no interaction, since the lines are parallel within the wiggle room allowed by the error bars, which means in that the effect of diet does not depend on supplement, and the effect of supplement does not depend on diet.

Now we will fit the simpler model and compare the two additive models:

```{r}
model_2<-lm(gain ~ diet + supp2, data = weights)
anova(model_1,model_2)
```

When we use `anova()` in this way it is testing the explanatory power of the second model against that of the first ie how much of the variance in the data does each explain. Its null hypothesis is that both models explain just as much of the variance as the other.

The simpler model has saved two degrees of freedom and is not significantly different in explanatory power than the more complex model (*p* = 0.158). Hence this is a better candidate as a minimal adequate model. All the parameters are significantly different from zero and from each other.

```{r}
summary(model_2)
```

In this table,

* line one (Intercept) tells us that the mean weight gain when on the barley diet and best supplement is 25.76 kg
* line two (dietoats) tells us that there is a significant drop in weight gain of 3.1 kg when diet is changed to oats.
* line three (dietwheat) tells us that there is a significant drop in weight gain of 5.99 kg when diet is changed to wheat.
* line four (sup2worst) tells us that there is a significant drop in wight gain of 2.68 kg when supplement is changed to worst.

In all cases, p< 0.001

We have now reduced our initial 12 parameter model to a four parameter model that is much more tractable and easier to communicate. Our advice would be that for maximum weight gain a diet of `barley` with a supplement of `agrimore` or `suppersupp` would be best.

[1]: Cumming, G., Fidler, F., & Vaux, D. L. (2007). Error bars in experimental biology. Journal of Cell Biology, 177(1), 7--11. <https://doi.org/10.1083/jcb.200611141>
